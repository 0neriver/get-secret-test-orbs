version: 2.1
# description: oneriver/get-secret-manager
description: This orbs is a test orbs to use the secret value specified from the GCP secret manager. It is for experimental purposes and should never be used for business purposes.

orbs:
  gcp-cli: circleci/gcp-cli@2.2.0

# commands:
#   hello:
#     description: get-secret-manager
#     parameters:
#       username:
#         type: string
#         description: your name
#     steps:
#       - run: 
#           name: get-secret-manager
#           command: |
#             USERNAME="$(echo << parameters.username >>)"
#             echo "Hello ${USERNAME}"
commands:
  get:
    description: get-secret-manager
    parameters:
      secret-name:
        type: string
        description: secret name
        default: "test-secret"
    steps:
      - gcp-cli/install
      - gcp-cli/initialize
      - run: 
          name: get latest version & set env from secret manager 
          working_directory: .
          command: |
            LATEST_VER=`gcloud secrets versions list << parameters.secret-name >> --limit=1 | awk '{print $1}' | sed -n 2p`
            echo LATEST_VER = ${LATEST_VER}
            gcloud secrets versions access ${LATEST_VER} \
            --secret=test-secret --format='get(payload.data)' | \
            tr '_-' '/+' | \
            base64 -d >> ./.env
      - run:
          command: |
            cat ./.env

      
